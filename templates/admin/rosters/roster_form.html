{% extends "layout/menu.html" %}

{% block title %}Roster - {{ match.home_team.name }} vs {{ match.away_team.name }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/global.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/roster.css') }}">
{% endblock %}

{% block content %}
<div class="roster-container">
    <h2 class="roster-title">Roster - {{ match.home_team.name }} vs {{ match.away_team.name }}</h2>

    <form method="POST">
        {% for team, team_name in [(match.home_team, "home"), (match.away_team, "away")] %}
            <div class="team-block">
                <div class="roster-label">{{ team.name }}</div>

                    <table class="roster-table">
                        <tr>
                            <th>Ordre</th>
                            <th>Titulaire</th>
                            <th>Pos</th>
                            <th>#</th>
                            <th>Remplaçant</th>
                            <th>Pos</th>
                            <th>#</th>
                        </tr>

                        {# Récupération du roster mappé (préparé dans le contrôleur Python) #}
                            {% set team_roster = roster_mapped.get(team.id) %}
                            {% set starters = team_roster.starters if team_roster else {} %}
                            {% set bench_list = team_roster.bench if team_roster else [] %}
                
                            {% for i in range(1, 11) %}
                                
                                {# Accès direct au Titulaire par l'ordre i #}
                                {% set starter = starters.get(i) %}
                
                                {# Assigner le i-ème Remplaçant de la liste #}
                                {% set bench = bench_list[i-1] if (i-1) < bench_list|length else None %}

                                <tr class="autocomplete-row" data-team="{{ team_name }}">
                                        <td>{{ i }}</td>

                                        {# Titulaire #}
                                        <td style="position:relative;">
                                                <input type="text"
                                                               name="starter_{{ team.id }}_{{ i }}_name"
                                                               placeholder="Titulaire"
                                                               value="{{ starter.player.first_name ~ ' ' ~ starter.player.last_name if starter }}">
                                                <input type="hidden"
                                                               name="starter_{{ team.id }}_{{ i }}_id"
                                                               value="{{ starter.player_id if starter }}">
                                                <div class="autocomplete-items"></div>
                                        </td>
                                        <td><input class="pos-field" maxlength="2"
                                                               name="starter_{{ team.id }}_{{ i }}_pos"
                                                               value="{{ starter.position if starter }}"></td>
                                        <td><input class="num-field" type="number"
                                                               name="starter_{{ team.id }}_{{ i }}_num"
                                                               value="{{ starter.number if starter }}"></td>

                                        {# Remplaçant #}
                                        <td style="position:relative;">
                                                <input type="text"
                                                               name="bench_{{ team.id }}_{{ i }}_name"
                                                               placeholder="Remplaçant"
                                                               value="{{ bench.player.first_name ~ ' ' ~ bench.player.last_name if bench }}">
                                                <input type="hidden"
                                                               name="bench_{{ team.id }}_{{ i }}_id"
                                                               value="{{ bench.player_id if bench }}">
                                                <div class="autocomplete-items"></div>
                                        </td>
                                        <td><input class="pos-field" maxlength="2"
                                                               name="bench_{{ team.id }}_{{ i }}_pos"
                                                               value="{{ bench.position if bench }}"></td>
                                        <td><input class="num-field" type="number"
                                                               name="bench_{{ team.id }}_{{ i }}_num"
                                                               value="{{ bench.number if bench }}"></td>
                                </tr>
                                {% endfor %}
                        </table>
                </div>
                <br><br>
                {% endfor %}

                <button class="save-btn">Enregistrer le roster</button>
        </form>
</div>

<script>
const players_home = [
        {% for p in players_by_team.get(match.home_team.id, []) %}
        {id: {{ p.id }}, name: "{{ p.first_name }} {{ p.last_name }}"},
        {% endfor %}
];

const players_away = [
        {% for p in players_by_team.get(match.away_team.id, []) %}
        {id: {{ p.id }}, name: "{{ p.first_name }} {{ p.last_name }}"},
        {% endfor %}
];

function autocomplete(input, hidden, list) {
        input.addEventListener("input", function () {
                const box = this.parentNode.querySelector(".autocomplete-items");
                box.innerHTML = "";
                if (!this.value) return;

                list.forEach(item => {
                        if (item.name.toLowerCase().includes(this.value.toLowerCase())) {
                                const div = document.createElement("div");
                                div.classList.add("autocomplete-item");
                                div.textContent = item.name;
                                div.onclick = () => {
                                        input.value = item.name;
                                        hidden.value = item.id;
                                        box.innerHTML = "";
                                };
                                box.appendChild(div);
                        }
                });
        });
}

document.querySelectorAll(".autocomplete-row").forEach(row => {
        const team = row.dataset.team;
        const list = team === "home" ? players_home : players_away;

        const inputs = row.querySelectorAll("input[type=text]");
        const hiddens = row.querySelectorAll("input[type=hidden]");

        autocomplete(inputs[0], hiddens[0], list);   // titulaire
        autocomplete(inputs[1], hiddens[1], list);   // remplaçant
});
</script>

{% endblock %}